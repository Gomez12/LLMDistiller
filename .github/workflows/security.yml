name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  schedule:
    # Run security scans daily at 1 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:

env:
  PYTHON_DEFAULT_VERSION: "3.11"

jobs:
  # Static Application Security Testing (SAST)
  sast:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit>=1.7.0 \
                    semgrep>=1.0.0 \
                    safety>=2.3.0 \
                    pip-audit>=2.5.0 \
                    truffleHog3>=0.1.0

    - name: Run Bandit SAST
      run: |
        bandit -r src/ \
               -f json \
               -o bandit-sast.json \
               -ll || true
        
        bandit -r src/ \
               -f txt \
               -o bandit-sast.txt \
               -ll || true

    - name: Run Semgrep SAST
      run: |
        semgrep --config=auto \
                --json \
                --output=semgrep-sast.json \
                src/ || true
        
        semgrep --config=auto \
                --text \
                --output=semgrep-sast.txt \
                src/ || true

    - name: Run TruffleHog secrets scan
      run: |
        trufflehog --json \
                  --output=trufflehog-secrets.json \
                  . || true
        
        trufflehog --text \
                  --output=trufflehog-secrets.txt \
                  . || true

    - name: Generate SAST report
      run: |
        python -c "
        import json
        import os
        from datetime import datetime
        
        print('## Static Application Security Testing (SAST)')
        print('')
        print(f'**Scan Date:** {datetime.now().isoformat()}')
        print(f'**Branch:** {os.environ.get(\"GITHUB_REF_NAME\", \"unknown\")}')
        print(f'**Commit:** {os.environ.get(\"GITHUB_SHA\", \"unknown\")[:8]}')
        print('')
        
        # Parse Bandit results
        bandit_issues = 0
        bandit_high = 0
        bandit_medium = 0
        bandit_low = 0
        
        try:
            with open('bandit-sast.json', 'r') as f:
                bandit_data = json.load(f)
            
            bandit_issues = len(bandit_data.get('results', []))
            
            for result in bandit_data.get('results', []):
                severity = result.get('issue_severity', 'UNKNOWN')
                if severity == 'HIGH':
                    bandit_high += 1
                elif severity == 'MEDIUM':
                    bandit_medium += 1
                elif severity == 'LOW':
                    bandit_low += 1
                    
        except FileNotFoundError:
            print('âš ï¸ Bandit report not found')
        
        # Parse Semgrep results
        semgrep_issues = 0
        semgrep_high = 0
        semgrep_medium = 0
        semgrep_low = 0
        
        try:
            with open('semgrep-sast.json', 'r') as f:
                semgrep_data = json.load(f)
            
            semgrep_results = semgrep_data.get('results', [])
            semgrep_issues = len(semgrep_results)
            
            for result in semgrep_results:
                metadata = result.get('metadata', {})
                severity = metadata.get('impact', 'INFO')
                
                if severity in ['HIGH', 'ERROR']:
                    semgrep_high += 1
                elif severity == 'MEDIUM':
                    semgrep_medium += 1
                elif severity == 'LOW':
                    semgrep_low += 1
                    
        except FileNotFoundError:
            print('âš ï¸ Semgrep report not found')
        
        # Parse TruffleHog results
        secrets_found = 0
        try:
            with open('trufflehog-secrets.json', 'r') as f:
                trufflehog_data = json.load(f)
            
            if isinstance(trufflehog_data, list):
                secrets_found = len(trufflehog_data)
            elif isinstance(trufflehog_data, dict):
                secrets_found = len(trufflehog_data.get('results', []))
                
        except (FileNotFoundError, json.JSONDecodeError):
            print('âš ï¸ TruffleHog report not found or invalid')
        
        # Display results
        print('### ðŸ” SAST Results Summary')
        print('')
        print('| Tool | Issues | High | Medium | Low |')
        print('|------|--------|------|--------|-----|')
        print(f'| Bandit | {bandit_issues} | {bandit_high} | {bandit_medium} | {bandit_low} |')
        print(f'| Semgrep | {semgrep_issues} | {semgrep_high} | {semgrep_medium} | {semgrep_low} |')
        print(f'| TruffleHog | {secrets_found} | - | - | - |')
        
        total_issues = bandit_issues + semgrep_issues + secrets_found
        total_high = bandit_high + semgrep_high
        total_medium = bandit_medium + semgrep_medium
        
        print('')
        print(f'**Total Issues Found:** {total_issues}')
        print(f'**High Severity:** {total_high}')
        print(f'**Medium Severity:** {total_medium}')
        print(f'**Secrets Found:** {secrets_found}')
        
        print('')
        
        # Risk assessment
        if total_high > 0:
            print('ðŸ”´ **HIGH RISK:** Critical security issues found!')
        elif total_medium > 5:
            print('ðŸŸ¡ **MEDIUM RISK:** Multiple security issues need attention')
        elif total_issues > 10:
            print('ðŸŸ¡ **MEDIUM RISK:** Many security issues found')
        elif total_issues > 0:
            print('ðŸŸ¢ **LOW RISK:** Some security issues found')
        else:
            print('ðŸŸ¢ **NO RISK:** No security issues detected')
        
        print('')
        print('### ðŸ“‹ Detailed Findings')
        print('')
        
        # High severity issues
        if total_high > 0:
            print('#### ðŸš¨ High Severity Issues')
            print('')
            
            if bandit_high > 0:
                print('**Bandit High Severity:**')
                try:
                    with open('bandit-sast.json', 'r') as f:
                        bandit_data = json.load(f)
                    
                    for result in bandit_data.get('results', []):
                        if result.get('issue_severity') == 'HIGH':
                            filename = result.get('filename', 'Unknown')
                            line = result.get('line_number', 0)
                            test_name = result.get('test_name', 'Unknown')
                            issue_text = result.get('issue_text', 'No description')
                            
                            print(f'- **{test_name}** in `{filename}:{line}`')
                            print(f'  - {issue_text}')
                except:
                    print('Could not parse Bandit high severity details')
            
            print('')
        
        # Secrets found
        if secrets_found > 0:
            print('#### ðŸ” Secrets Found')
            print('')
            print(f'âš ï¸ **{secrets_found} potential secrets detected!**')
            print('Review the TruffleHog report immediately.')
            print('')
            print('**Immediate Actions Required:**')
            print('1. Rotate any exposed credentials')
            print('2. Remove secrets from code history')
            print('3. Add secrets to environment variables')
            print('4. Update .gitignore to prevent future commits')
            print('')
        
        # Recommendations
        print('### ðŸ’¡ Security Recommendations')
        print('')
        
        if total_high > 0:
            print('- **URGENT:** Fix high severity security issues immediately')
            print('- Review and patch all critical vulnerabilities')
        
        if total_medium > 0:
            print('- Address medium severity issues in next release')
            print('- Implement secure coding practices')
        
        if secrets_found > 0:
            print('- **CRITICAL:** Remove all exposed secrets')
            print('- Implement proper secrets management')
        
        if bandit_issues > 0:
            print('- Review Bandit findings for common security issues')
            print('- Focus on input validation and SQL injection prevention')
        
        if semgrep_issues > 0:
            print('- Review Semgrep findings for code quality issues')
            print('- Address potential security anti-patterns')
        
        if total_issues == 0:
            print('- ðŸŽ‰ Excellent security posture!')
            print('- Continue regular security scanning')
            print('- Implement security testing in CI/CD pipeline')
        
        # Save metrics
        sast_metrics = {
            'total_issues': total_issues,
            'high_severity': total_high,
            'medium_severity': total_medium,
            'bandit_issues': bandit_issues,
            'semgrep_issues': semgrep_issues,
            'secrets_found': secrets_found,
            'scan_date': datetime.now().isoformat()
        }
        
        with open('sast_metrics.json', 'w') as f:
            json.dump(sast_metrics, f, indent=2)
        " >> $GITHUB_STEP_SUMMARY

    - name: Upload SAST artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: |
          bandit-sast.json
          bandit-sast.txt
          semgrep-sast.json
          semgrep-sast.txt
          trufflehog-secrets.json
          trufflehog-secrets.txt
          sast_metrics.json
        retention-days: 30

  # Dependency Security Scanning
  dependency-security:
    name: Dependency Security Scanning
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety>=2.3.0 \
                    pip-audit>=2.5.0 \
                    pip-tools>=7.0.0

    - name: Run Safety dependency scan
      run: |
        safety check --json --output=safety-deps.json || true
        safety check --full-report --output=safety-deps.txt || true

    - name: Run pip-audit dependency scan
      run: |
        pip-audit --requirement requirements.txt \
                  --format=json \
                  --output=pip-audit-deps.json || true
        
        pip-audit --requirement requirements.txt \
                  --format=columns \
                  --output=pip-audit-deps.txt || true

    - name: Run pip-audit on dev dependencies
      run: |
        pip-audit --requirement requirements-dev.txt \
                  --format=json \
                  --output=pip-audit-dev-deps.json || true

    - name: Generate dependency security report
      run: |
        python -c "
        import json
        from datetime import datetime
        
        print('## Dependency Security Scanning')
        print('')
        print(f'**Scan Date:** {datetime.now().isoformat()}')
        print('')
        
        # Parse Safety results
        safety_vulns = []
        try:
            with open('safety-deps.json', 'r') as f:
                safety_data = json.load(f)
            safety_vulns = safety_data.get('vulnerabilities', [])
        except FileNotFoundError:
            print('âš ï¸ Safety report not found')
        
        # Parse pip-audit results
        audit_vulns = []
        try:
            with open('pip-audit-deps.json', 'r') as f:
                audit_data = json.load(f)
            audit_vulns = audit_data.get('vulnerabilities', [])
        except FileNotFoundError:
            print('âš ï¸ pip-audit report not found')
        
        # Parse dev dependencies
        audit_dev_vulns = []
        try:
            with open('pip-audit-dev-deps.json', 'r') as f:
                audit_dev_data = json.load(f)
            audit_dev_vulns = audit_dev_data.get('vulnerabilities', [])
        except FileNotFoundError:
            print('âš ï¸ pip-audit dev report not found')
        
        total_vulns = len(safety_vulns) + len(audit_vulns)
        total_dev_vulns = len(audit_dev_vulns)
        
        print('### ðŸ“¦ Dependency Vulnerability Summary')
        print('')
        print('| Scanner | Vulnerabilities | Severity |')
        print('|---------|----------------|----------|')
        print(f'| Safety | {len(safety_vulns)} | Mixed |')
        print(f'| pip-audit (prod) | {len(audit_vulns)} | Mixed |')
        print(f'| pip-audit (dev) | {len(audit_dev_vulns)} | Mixed |')
        print(f'| **Total** | **{total_vulns}** | **Mixed** |')
        
        print('')
        
        if total_vulns > 0:
            print('ðŸ”´ **VULNERABLE DEPENDENCIES DETECTED**')
        elif total_dev_vulns > 0:
            print('ðŸŸ¡ **VULNERABLE DEV DEPENDENCIES DETECTED**')
        else:
            print('ðŸŸ¢ **NO VULNERABILITIES FOUND**')
        
        print('')
        
        # Show critical vulnerabilities
        critical_vulns = []
        for vuln in safety_vulns + audit_vulns:
            if vuln.get('severity', '').upper() in ['CRITICAL', 'HIGH']:
                critical_vulns.append(vuln)
        
        if critical_vulns:
            print('### ðŸš¨ Critical Vulnerabilities')
            print('')
            print('| Package | Version | Vulnerability | Severity |')
            print('|---------|---------|---------------|----------|')
            
            for vuln in critical_vulns[:10]:  # Show first 10
                package = vuln.get('package', 'Unknown')
                version = vuln.get('version', 'Unknown')
                vuln_id = vuln.get('vulnerability_id', vuln.get('id', 'Unknown'))
                severity = vuln.get('severity', 'Unknown')
                
                print(f'| {package} | {version} | {vuln_id} | {severity} |')
            
            if len(critical_vulns) > 10:
                print(f'| ... | ... | ... | ... |')
                print(f'| and {len(critical_vulns) - 10} more | | | |')
        
        print('')
        print('### ðŸ’¡ Dependency Security Recommendations')
        print('')
        
        if total_vulns > 0:
            print('- **URGENT:** Update vulnerable dependencies')
            print('- Use `pip install --upgrade` to update packages')
            print('- Consider using pip-tools for dependency pinning')
            print('- Review and test updates before deployment')
        
        if total_dev_vulns > 0:
            print('- Update development dependencies')
            print('- Review build and test tool dependencies')
        
        if critical_vulns:
            print('- **CRITICAL:** Address critical/high severity vulnerabilities immediately')
            print('- These may allow remote code execution or data breaches')
        
        if total_vulns == 0 and total_dev_vulns == 0:
            print('- ðŸŽ‰ All dependencies are secure!')
            print('- Continue regular dependency scanning')
            print('- Set up automated dependency updates')
        
        # Save metrics
        dep_metrics = {
            'total_vulnerabilities': total_vulns,
            'dev_vulnerabilities': total_dev_vulns,
            'safety_vulnerabilities': len(safety_vulns),
            'audit_vulnerabilities': len(audit_vulns),
            'critical_vulnerabilities': len(critical_vulns),
            'scan_date': datetime.now().isoformat()
        }
        
        with open('dependency_security_metrics.json', 'w') as f:
            json.dump(dep_metrics, f, indent=2)
        " >> $GITHUB_STEP_SUMMARY

    - name: Upload dependency security artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dependency-security-reports
        path: |
          safety-deps.json
          safety-deps.txt
          pip-audit-deps.json
          pip-audit-deps.txt
          pip-audit-dev-deps.json
          dependency_security_metrics.json
        retention-days: 30

  # Container Security (if Dockerfile exists)
  container-security:
    name: Container Security Scanning
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Check for Dockerfile
      id: check-dockerfile
      run: |
        if [ -f "Dockerfile" ] || ls Dockerfile* 1> /dev/null 2>&1; then
          echo "dockerfile_exists=true" >> $GITHUB_OUTPUT
        else
          echo "dockerfile_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Set up Docker Buildx
      if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        load: true
        tags: llm-distiller:security-scan
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run Trivy container scan
      if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
      run: |
        # Install Trivy
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        # Scan container
        trivy image --format json --output trivy-container.json llm-distiller:security-scan || true
        trivy image --format table --output trivy-container.txt llm-distiller:security-scan || true

    - name: Generate container security report
      if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
      run: |
        python -c "
        import json
        from datetime import datetime
        
        print('## Container Security Scanning')
        print('')
        print(f'**Scan Date:** {datetime.now().isoformat()}')
        print('')
        
        try:
            with open('trivy-container.json', 'r') as f:
                trivy_data = json.load(f)
            
            results = trivy_data.get('Results', [])
            total_vulns = 0
            critical_vulns = 0
            high_vulns = 0
            medium_vulns = 0
            low_vulns = 0
            
            for result in results:
                vulns = result.get('Vulnerabilities', [])
                total_vulns += len(vulns)
                
                for vuln in vulns:
                    severity = vuln.get('Severity', 'UNKNOWN').upper()
                    if severity == 'CRITICAL':
                        critical_vulns += 1
                    elif severity == 'HIGH':
                        high_vulns += 1
                    elif severity == 'MEDIUM':
                        medium_vulns += 1
                    elif severity == 'LOW':
                        low_vulns += 1
            
            print('### ðŸ³ Container Vulnerability Summary')
            print('')
            print('| Severity | Count |')
            print('|----------|-------|')
            print(f'| Critical | {critical_vulns} |')
            print(f'| High | {high_vulns} |')
            print(f'| Medium | {medium_vulns} |')
            print(f'| Low | {low_vulns} |')
            print(f'| **Total** | **{total_vulns}** |')
            
            print('')
            
            if critical_vulns > 0:
                print('ðŸ”´ **CRITICAL:** Container has critical vulnerabilities!')
            elif high_vulns > 0:
                print('ðŸŸ¡ **HIGH RISK:** Container has high severity vulnerabilities!')
            elif total_vulns > 0:
                print('ðŸŸ¡ **MEDIUM RISK:** Container has vulnerabilities')
            else:
                print('ðŸŸ¢ **SECURE:** No container vulnerabilities found')
            
            print('')
            print('### ðŸ’¡ Container Security Recommendations')
            print('')
            
            if critical_vulns > 0 or high_vulns > 0:
                print('- **URGENT:** Update base image to fix critical/high vulnerabilities')
                print('- Use minimal base images (alpine, distroless)')
                print('- Implement regular image scanning in CI/CD')
            
            if total_vulns > 0:
                print('- Update package dependencies in container')
                print('- Consider multi-stage builds to reduce attack surface')
                print('- Implement security scanning in build pipeline')
            
            if total_vulns == 0:
                print('- ðŸŽ‰ Container is secure!')
                print('- Continue regular container scanning')
                print('- Use signed images and content trust')
        
        except FileNotFoundError:
            print('âš ï¸ Trivy container scan report not found')
        except Exception as e:
            print(f'âš ï¸ Error parsing container scan report: {e}')
        " >> $GITHUB_STEP_SUMMARY

    - name: Upload container security artifacts
      if: steps.check-dockerfile.outputs.dockerfile_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: container-security-reports
        path: |
          trivy-container.json
          trivy-container.txt
        retention-days: 30

  # Security Score Calculation
  security-score:
    name: Security Score
    runs-on: ubuntu-latest
    needs: [sast, dependency-security, container-security]
    if: always()
    steps:
    - name: Download all security reports
      uses: actions/download-artifact@v4
      with:
        path: ./reports

    - name: Calculate overall security score
      run: |
        python -c "
        import json
        from datetime import datetime
        
        print('## ðŸ”’ Overall Security Score')
        print('')
        print(f'**Assessment Date:** {datetime.now().isoformat()}')
        print('')
        
        # Load metrics
        sast_metrics = {}
        dep_metrics = {}
        
        try:
            with open('reports/sast-reports/sast_metrics.json', 'r') as f:
                sast_metrics = json.load(f)
        except FileNotFoundError:
            pass
        
        try:
            with open('reports/dependency-security-reports/dependency_security_metrics.json', 'r') as f:
                dep_metrics = json.load(f)
        except FileNotFoundError:
            pass
        
        # Calculate component scores
        sast_score = 100
        dep_score = 100
        container_score = 100
        
        # SAST scoring
        sast_issues = sast_metrics.get('total_issues', 0)
        sast_high = sast_metrics.get('high_severity', 0)
        sast_secrets = sast_metrics.get('secrets_found', 0)
        
        if sast_secrets > 0:
            sast_score = 0  # Secrets are critical
        elif sast_high > 0:
            sast_score = max(0, 100 - (sast_high * 25))
        else:
            sast_score = max(0, 100 - (sast_issues * 5))
        
        # Dependency scoring
        dep_vulns = dep_metrics.get('total_vulnerabilities', 0)
        dep_critical = dep_metrics.get('critical_vulnerabilities', 0)
        
        if dep_critical > 0:
            dep_score = max(0, 100 - (dep_critical * 30))
        else:
            dep_score = max(0, 100 - (dep_vulns * 10))
        
        # Container scoring (if available)
        try:
            with open('reports/container-security-reports/trivy-container.json', 'r') as f:
                trivy_data = json.load(f)
            
            total_container_vulns = 0
            critical_container_vulns = 0
            
            for result in trivy_data.get('Results', []):
                vulns = result.get('Vulnerabilities', [])
                total_container_vulns += len(vulns)
                
                for vuln in vulns:
                    if vuln.get('Severity', '').upper() == 'CRITICAL':
                        critical_container_vulns += 1
            
            if critical_container_vulns > 0:
                container_score = max(0, 100 - (critical_container_vulns * 20))
            else:
                container_score = max(0, 100 - (total_container_vulns * 5))
        
        except FileNotFoundError:
            container_score = None  # No container to score
        
        # Calculate overall score
        scores = [sast_score, dep_score]
        if container_score is not None:
            scores.append(container_score)
        
        overall_score = sum(scores) / len(scores)
        
        # Display results
        print('### ðŸ“Š Security Component Scores')
        print('')
        print('| Component | Score | Issues | Status |')
        print('|-----------|-------|---------|--------|')
        
        def get_status_emoji(score):
            if score >= 90: return 'ðŸŸ¢'
            elif score >= 70: return 'ðŸŸ¡'
            elif score >= 50: return 'ðŸŸ '
            else: return 'ðŸ”´'
        
        print(f'| SAST | {sast_score:.0f}/100 | {sast_issues} | {get_status_emoji(sast_score)} |')
        print(f'| Dependencies | {dep_score:.0f}/100 | {dep_vulns} | {get_status_emoji(dep_score)} |')
        
        if container_score is not None:
            print(f'| Container | {container_score:.0f}/100 | - | {get_status_emoji(container_score)} |')
        
        print('')
        print(f'### ðŸŽ¯ Overall Security Score: {overall_score:.0f}/100')
        print('')
        
        # Score visualization
        def get_score_bar(score):
            filled = int(score / 10)
            empty = 10 - filled
            return 'â–ˆ' * filled + 'â–‘' * empty
        
        print(f'{get_score_bar(overall_score)} {overall_score:.0f}%')
        print('')
        
        # Risk assessment
        if sast_secrets > 0:
            print('ðŸ”´ **CRITICAL RISK:** Exposed secrets detected!')
        elif sast_high > 0 or dep_critical > 0:
            print('ðŸ”´ **HIGH RISK:** Critical security issues found!')
        elif overall_score < 70:
            print('ðŸŸ¡ **MEDIUM RISK:** Multiple security issues need attention')
        elif overall_score < 90:
            print('ðŸŸ¡ **LOW RISK:** Some security improvements needed')
        else:
            print('ðŸŸ¢ **LOW RISK:** Good security posture')
        
        print('')
        print('### ðŸ›¡ï¸ Security Recommendations')
        print('')
        
        if sast_secrets > 0:
            print('1. **IMMEDIATE ACTION REQUIRED:** Remove exposed secrets')
            print('2. Rotate all compromised credentials')
            print('3. Implement proper secrets management')
        
        if sast_high > 0:
            print('1. Fix high-severity code security issues')
            print('2. Review and patch vulnerable code paths')
        
        if dep_critical > 0:
            print('1. Update critical vulnerable dependencies')
            print('2. Review dependency security advisories')
        
        if overall_score >= 90:
            print('1. ðŸŽ‰ Excellent security posture!')
            print('2. Continue regular security monitoring')
            print('3. Implement security testing in development lifecycle')
        elif overall_score >= 70:
            print('1. Address remaining security issues')
            print('2. Implement security best practices')
        else:
            print('1. **URGENT:** Address critical security issues')
            print('2. Implement comprehensive security program')
            print('3. Consider security audit or penetration testing')
        
        print('')
        print('---')
        print('*This security assessment is automated and should be supplemented with manual security reviews.*')
        " >> $GITHUB_STEP_SUMMARY

  # Security Summary
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sast, dependency-security, container-security, security-score]
    if: always()
    steps:
    - name: Create security summary
      run: |
        echo "## ðŸ”’ Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- SAST: ${{ needs.sast.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency Security: ${{ needs.dependency-security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Container Security: ${{ needs.container-security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Score: ${{ needs.security-score.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        if [[ "${{ needs.sast.result }}" == "success" && "${{ needs.dependency-security.result }}" == "success" ]]; then
          echo "âœ… Security scanning completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Security scanning encountered issues" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Security Checklist" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Review SAST findings for code vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Check for exposed secrets in codebase" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Update vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Review container security (if applicable)" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Implement security best practices" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Resources" >> $GITHUB_STEP_SUMMARY
        echo "- [OWASP Top 10](https://owasp.org/www-project-top-ten/)" >> $GITHUB_STEP_SUMMARY
        echo "- [CWE Mitigations](https://cwe.mitre.org/)" >> $GITHUB_STEP_SUMMARY
        echo "- [Security Best Practices](https://docs.python.org/3/security/index.html)" >> $GITHUB_STEP_SUMMARY